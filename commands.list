# Step 0:  Getting ready before we start
#If using windows, you will have to install and run jenkins on your docker-machine VM (just docker-machine ssh, and git clone this again in an appropriate location there)
#you may also take this approach on the mac, or you may perform tasks natively on mac (homebrew STRONGLY recommended)
#To enter docker-machine vm:
docker-machine ssh
#create a directory to work from for this class and:
git clone https://github.com/jfrogtraining/docker-lifecycle-scripts.git
curl -uadmin:password http://artifactory-us.jfrog.info/jfrog-cli/1.2.1/jfrog-cli-linux-amd64/jfrog -O
#then run all further commands from there


#To prep mac:
#install homebrew (if not already installed)
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
#or if already installed:
brew update
export HOMEBREW_BOTTLE_DOMAIN=https://10.60.1.73/artifactory
brew install gnu-sed
brew install jfrog-cli-go
#if you already have jfrog-cli-go installed please ugrade just in case:
brew upgrade jfrog-cli-go

# Step 1:  build an artifactory server to use
# First Get a license
#If not on mac browse to: https://artifactory-us.jfrog.info/artifactory/jfrog-cli/1.2.0/
#And select the appropriate binary for your distribution
#Then build it.
git clone https://github.com/JFrogDev/artifactory-user-plugins.git
docker build .

#if following commands with CLI do not work try using ./jfrog instead of just jfrog
jfrog mc c --url=http://10.60.1.221:8080 --user=admin --password=password --interactive=false
jfrog mc rti attach-lic <userName> --bucket-id=abcdefg --bucket-key= 2c1fa1029a24a9c4b31f1117e3dc88aebbbceb9a6a96857773fd0f0c2cf52e03 --license-path=assets/artifactory.lic

#Step 2: Pull jenkins image
docker pull artifactory.local/training/jenkins

#Step 3: Setup docker
export ARTIFACTORY_HOME=/var/opt/jfrog/artifactory
curl http://artifactory-us.jfrog.info/artifactory/installations-local/artifactory-H1.lic -o ./assets/artifactory.lic
#Update HOSTS file (/etc/hosts on mac/linux system32 path for windows) (ED NOTE:  Get Proper Windows Path!) (ED NOTE:  Fix Windows/NGINX config.  Update this in docker-registry directly by adding docker-prod-virtual?)
<docker-machine IP> docker-virtual.art.local docker-dev-local2.art.local docker-prod-local2.art.local
#Update insecure registries (ED NOTE:  Try to fix this by having real certs!)
DOCKER_OPTS="$DOCKER_OPTS --insecure-registry docker-virtual.art.local --insecure-registry docker-dev-local2.art.local --insecure-registry docker-prod-local2.art.local --insecure-registry docker-remote.art.local"
docker run -d --name art-docker -p 80:80 -p 8081:8081 -p 443:443 <hash>
export DOCKER_ART_URL="http://192.168.243.128:8081/artifactory"
cd configArt
./configArt.sh

#Step 4: Configure Tomcat Dependency
jfrog rt config --url=$DOCKER_ART_URL --user=admin --password=password --interactive=false
jfrog rt cp apache-archive-cache/tomcat/tomcat-8/v8.0.32/bin/apache-tomcat-8.0.32.tar.gz tomcat-local/org/apache/apache-tomcat/pache-tomcat-8.0.32.tar.gz

#Step 5: Run App
docker run -d --name test-app2 -p 8181:8181 883d7f53e798
